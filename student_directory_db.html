<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Directory</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Modal background styling */
        .modal-bg {
            background-color: rgba(0, 0, 0, 0.7);
        }
    </style>
</head>
<body class="flex flex-col min-h-screen bg-blue-950 text-gray-100">

    <!-- Header -->
    <header class="bg-blue-900 shadow-lg p-6">
        <div class="container mx-auto flex flex-col sm:flex-row justify-between items-center">
            <!-- Logo and Title -->
            <a href="#" class="flex items-center space-x-3 mb-4 sm:mb-0">
                <img src="https://neust.edu.ph/wp-content/uploads/2020/06/neust_logo.png" alt="NEUST Logo" class="h-10 w-auto">
                <span class="text-xl font-bold text-white">NEUST - Digital Yearbook</span>
            </a>
            <!-- Navigation Links -->
            <div class="flex items-center space-x-6">
                <nav>
                    <ul class="flex space-x-6">
                        <li><a href="index.html" class="text-gray-300 hover:text-sky-300 transition-colors duration-300 font-medium">Home</a></li>
                        <li><a href="#" class="text-sky-300 font-bold transition-colors duration-300">Student Directory</a></li>
                        <li><a href="#" class="text-gray-300 hover:text-sky-300 transition-colors duration-300 font-medium">About</a></li>
                        <li><a href="#" class="text-gray-300 hover:text-sky-300 transition-colors duration-300 font-medium">Contact</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content (Student Directory) -->
    <main class="flex-grow flex flex-col items-center p-8">
        <!-- Student Search Results Section -->
        <section class="container mx-auto mt-8">
            <h2 class="text-center text-3xl font-bold text-white mb-6">Student Directory</h2>
            <!-- Search Bar -->
            <div class="relative max-w-lg mx-auto mb-8">
                <input id="search-input" type="text" placeholder="Search students..." class="bg-blue-800 text-white placeholder-gray-400 rounded-full py-3 px-6 focus:outline-none focus:ring-2 focus:ring-sky-500 transition-all duration-300 w-full text-center">
                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                </svg>
            </div>
            <div id="student-results" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Student cards will be dynamically inserted here -->
            </div>
            <p id="no-results-message" class="text-center text-gray-400 text-lg mt-8 hidden">
                No students found with that name. Please try another search.
            </p>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-blue-900 shadow-inner p-6">
        <div class="container mx-auto text-center text-gray-400 text-sm">
            <p>&copy; 2025 NEUST. All rights reserved.</p>
            <div class="flex justify-center space-x-4 mt-2">
                <a href="#" class="hover:text-white transition-colors duration-300">Facebook</a>
                <a href="#" class="hover:text-white transition-colors duration-300">Twitter</a>
                <a href="#" class="hover:text-white transition-colors duration-300">LinkedIn</a>
            </div>
        </div>
    </footer>

    <!-- Student Detail Modal (Read-Only) -->
    <div id="student-modal" class="fixed inset-0 z-50 hidden flex justify-center items-center p-4 modal-bg">
        <div class="bg-blue-900 rounded-lg shadow-2xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-2xl font-bold text-white">Student Details</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-white transition-colors duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div id="view-mode-details">
                <div class="text-center mb-4">
                    <img id="modal-student-photo" src="" alt="Student Photo" class="rounded-full w-32 h-32 mx-auto mb-4 object-cover">
                    <p id="modal-student-name" class="text-2xl font-bold text-white mb-2"></p>
                    <p id="modal-student-course" class="text-lg text-gray-300"></p>
                </div>
                <p id="modal-student-details" class="text-gray-200 text-base leading-relaxed"></p>
            </div>
            <!-- Edit form elements are intentionally omitted for user-only view -->
        </div>
    </div>

    <script>
        window.onload = function() {
            // --- Firebase Initialization ---
            const firebaseConfig = {
                apiKey: "AIzaSyDDD1s6cSY16oPy40Wb6XfARf5BzHo0c6A",
                authDomain: "interactive-digital-yearbook.firebaseapp.com",
                projectId: "interactive-digital-yearbook",
                storageBucket: "interactive-digital-yearbook.firebasestorage.app",
                messagingSenderId: "814017258642",
                appId: "1:814017258642:web:aa40678665af257f1ef24b"
            };

            const config = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            const app = firebase.initializeApp(config);
            const db = app.firestore();
            const auth = app.auth();
            
            let students = []; // Students will be populated from Firestore

            // DOM Elements for Search and Student Display
            const searchInput = document.getElementById('search-input');
            const studentResultsDiv = document.getElementById('student-results');
            const noResultsMessage = document.getElementById('no-results-message');

            // DOM Elements for Student Detail Modal
            const studentModal = document.getElementById('student-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const modalTitle = document.getElementById('modal-title');
            const modalStudentName = document.getElementById('modal-student-name');
            const modalStudentPhoto = document.getElementById('modal-student-photo');
            const modalStudentCourse = document.getElementById('modal-student-course');
            const modalStudentDetails = document.getElementById('modal-student-details');

            // Firestore collection path for students (public data)
            const studentsCollectionRef = db.collection(`artifacts/${appId}/public/data/students`);

            /**
             * Fetches all student data from Firestore.
             */
            async function fetchStudents() {
                try {
                    const snapshot = await studentsCollectionRef.orderBy("name").get();
                    students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log("Fetched students for user view:", students); // Log fetched data
                    handleSearch(); // Re-render the UI with fetched students
                } catch (error) {
                    console.error("Error fetching students for user view:", error);
                    // No alert here, as users might not have write permissions, but should read.
                    // Ensure Firestore rules allow read for 'request.auth != null'.
                }
            }

            /**
             * Renders a list of student cards to the DOM.
             * This version is for user view, so no admin controls.
             * @param {Array} studentList - The array of student objects to display.
             */
            function renderStudents(studentList) {
                studentResultsDiv.innerHTML = '';
                noResultsMessage.classList.add('hidden');

                if (studentList.length === 0) {
                    noResultsMessage.classList.remove('hidden');
                    return;
                }

                studentList.forEach(student => {
                    const card = document.createElement('div');
                    card.classList.add(
                        'bg-blue-900', 'p-4', 'rounded-lg', 'shadow-lg', 
                        'text-center', 'cursor-pointer', 'hover:bg-blue-800', 
                        'transition-colors', 'duration-300', 'relative'
                    ); 
                    
                    // No admin buttons for user view
                    card.innerHTML = `
                        <img src="${student.photo}" alt="${student.name}" class="rounded-full w-24 h-24 mx-auto mb-4 object-cover">
                        <h3 class="text-xl font-bold text-white">${student.name}</h3>
                        <p class="text-gray-400 mt-2 text-sm">${student.course}</p>
                    `;
                    
                    card.addEventListener('click', () => {
                        displayStudentDetails(student);
                    });
                    studentResultsDiv.appendChild(card);
                });
            }

            /**
             * Displays the details of a specific student in the modal.
             * @param {Object} student - The student object to display.
             */
            function displayStudentDetails(student) {
                modalTitle.textContent = "Student Details";
                // Only view mode exists, so no toggling needed
                modalStudentName.textContent = student.name;
                modalStudentPhoto.src = student.photo;
                modalStudentPhoto.alt = student.name;
                modalStudentCourse.textContent = student.course;
                modalStudentDetails.textContent = student.details;
                studentModal.classList.remove('hidden');
            }
            
            /**
             * Filters the student list based on the search query and renders the results.
             * This operates on the 'students' array which is populated from Firestore.
             */
            function handleSearch() {
                const query = searchInput.value.toLowerCase().trim();
                console.log("Search query (user view):", query);
                console.log("Current students array length (user view):", students.length);
                const filteredStudents = students.filter(student => {
                    const studentName = student.name ? student.name.toLowerCase() : '';
                    const studentCourse = student.course ? student.course.toLowerCase() : '';
                    return studentName.includes(query) || studentCourse.includes(query);
                });
                console.log("Filtered students length (user view):", filteredStudents.length, filteredStudents);
                renderStudents(filteredStudents);
            }

            // --- Event Listeners and Initial Load ---
            
            // Listen for Firebase Authentication state changes to ensure a user is signed in
            auth.onAuthStateChanged(async user => {
                if (!user) { // If no user is signed in (neither admin nor anonymous)
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                         try {
                            await auth.signInWithCustomToken(__initial_auth_token);
                            console.log("User view: Signed in with Canvas custom token.");
                        } catch (tokenError) {
                            console.error("User view: Error signing in with custom token:", tokenError);
                             // Fallback to anonymous if custom token fails
                            try {
                                await auth.signInAnonymously();
                                console.log("User view: Signed in anonymously after custom token failure.");
                            } catch (anonError) {
                                console.error("User view: Error signing in anonymously:", anonError);
                            }
                        }
                    } else {
                        try {
                            await auth.signInAnonymously();
                            console.log("User view: Signed in anonymously.");
                        } catch (error) {
                            console.error("User view: Error signing in anonymously:", error);
                        }
                    }
                }
                fetchStudents(); // Fetch students once authentication state is known
            });
            
            searchInput.addEventListener('input', handleSearch);

            closeModalBtn.addEventListener('click', () => {
                studentModal.classList.add('hidden');
            });

            studentModal.addEventListener('click', (event) => {
                if (event.target === studentModal) {
                    studentModal.classList.add('hidden');
                }
            });
        };
    </script>

</body>
</html>
