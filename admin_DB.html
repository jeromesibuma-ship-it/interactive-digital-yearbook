<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Admin DB</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs - Add these for Firebase functionality -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Modal background styling */
        .modal-bg {
            background-color: rgba(0, 0, 0, 0.7);
        }

        /* Style for admin mode indicator */
        .admin-active {
            box-shadow: 0 0 10px 3px #fde047; /* Tailwind yellow-300 shadow */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen bg-blue-950 text-gray-100 relative">

    <!-- Header -->
    <header class="bg-blue-900 shadow-lg p-6 relative z-10">
        <div class="container mx-auto flex flex-col sm:flex-row justify-between items-center">
            <!-- Logo and Title -->
            <a href="#" class="flex items-center space-x-3 mb-4 sm:mb-0">
                <img src="https://neust.edu.ph/wp-content/uploads/2020/06/neust_logo.png" alt="NEUST Logo" class="h-10 w-auto">
                <span class="text-xl font-bold text-white">NEUST - Digital Yearbook</span>
            </a>
            <!-- Navigation Links -->
            <div class="flex items-center space-x-6">
                <nav>
                    <ul class="flex space-x-6">
                        <li><a href="#" class="text-gray-300 hover:text-sky-300 transition-colors duration-300 font-medium">Home</a></li>
                        <li><a href="#" class="text-gray-300 hover:text-sky-300 transition-colors duration-300 font-medium">About</a></li>
                        <li><a href="#" class="text-gray-300 hover:text-sky-300 transition-colors duration-300 font-medium">Services</a></li>
                        <li><a href="#" class="text-gray-300 hover:text-sky-300 transition-colors duration-300 font-medium">Contact</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content (Student Directory) -->
    <main class="flex-grow flex flex-col items-center p-8 relative z-10">
        <!-- Admin Access Section -->
        <section class="container mx-auto mt-4 mb-8 bg-blue-800 p-6 rounded-lg shadow-lg max-w-xl text-center">
            <h3 class="text-xl font-bold mb-4 text-white">Admin Access</h3>
            <div id="admin-login-area">
                <input type="email" id="admin-email-input" placeholder="Admin Email" class="bg-blue-700 text-white placeholder-gray-400 rounded-full py-2 px-4 focus:outline-none focus:ring-2 focus:ring-sky-500 w-full mb-2">
                <input type="password" id="admin-password-input" placeholder="Admin Password" class="bg-blue-700 text-white placeholder-gray-400 rounded-full py-2 px-4 focus:outline-none focus:ring-2 focus:ring-sky-500 w-full mb-4">
                <button id="admin-login-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-6 rounded-full transition-colors duration-300">
                    Enable Admin Mode
                </button>
            </div>
            <div id="admin-controls-area" class="hidden mt-4">
                <p class="text-yellow-300 font-semibold mb-4">Admin Mode Active! <span id="admin-message"></span></p>
                <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                    <button id="add-student-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-6 rounded-full transition-colors duration-300">
                        Add New Student
                    </button>
                    <button id="reset-students-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-full transition-colors duration-300">
                        Reset Student Data
                    </button>
                    <button id="admin-logout-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-full transition-colors duration-300">
                        Disable Admin Mode
                    </button>
                </div>
                <p class="text-yellow-300 text-sm mt-4">
                    *Changes made in Admin Mode are now permanent (stored in Firebase) for authenticated users.
                </p>
            </div>
        </section>

        <!-- Student Search Results Section -->
        <section class="container mx-auto mt-8">
            <h2 class="text-center text-3xl font-bold text-white mb-6">Student Directory</h2>
            <!-- Search Bar -->
            <div class="relative max-w-lg mx-auto mb-8">
                <input id="search-input" type="text" placeholder="Search students..." class="bg-blue-800 text-white placeholder-gray-400 rounded-full py-3 px-6 focus:outline-none focus:ring-2 focus:ring-sky-500 transition-all duration-300 w-full text-center">
                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                </svg>
            </div>
            <div id="student-results" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Student cards will be dynamically inserted here -->
            </div>
            <p id="no-results-message" class="text-center text-gray-400 text-lg mt-8 hidden">
                No students found with that name. Please try another search.
            </p>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-blue-900 shadow-inner p-6 relative z-10">
        <div class="container mx-auto text-center text-gray-400 text-sm">
            <p>&copy; 2025 NEUST. All rights reserved.</p>
            <div class="flex justify-center space-x-4 mt-2">
                <a href="#" class="hover:text-white transition-colors duration-300">Facebook</a>
                <a href="#" class="hover:text-white transition-colors duration-300">Twitter</a>
                <a href="#" class="hover:text-white transition-colors duration-300">LinkedIn</a>
            </div>
        </div>
    </footer>

    <!-- Student Detail / Edit Modal -->
    <div id="student-modal" class="fixed inset-0 z-50 hidden flex justify-center items-center p-4 modal-bg">
        <div class="bg-blue-900 rounded-lg shadow-2xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-2xl font-bold text-white">Student Details</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-white transition-colors duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div id="view-mode-details">
                <div class="text-center mb-4">
                    <img id="modal-student-photo" src="" alt="Student Photo" class="rounded-full w-32 h-32 mx-auto mb-4 object-cover">
                    <p id="modal-student-name" class="text-2xl font-bold text-white mb-2"></p>
                    <p id="modal-student-course" class="text-lg text-gray-300"></p>
                </div>
                <p id="modal-student-details" class="text-gray-200 text-base leading-relaxed"></p>
            </div>

            <div id="edit-mode-form" class="hidden">
                <input type="hidden" id="edit-student-id">
                <div class="mb-4">
                    <label for="edit-name" class="block text-gray-300 text-sm font-bold mb-2">Name:</label>
                    <input type="text" id="edit-name" class="shadow appearance-none border rounded w-full py-2 px-3 bg-blue-800 text-white leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="mb-4">
                    <label for="edit-course" class="block text-gray-300 text-sm font-bold mb-2">Course:</label>
                    <input type="text" id="edit-course" class="shadow appearance-none border rounded w-full py-2 px-3 bg-blue-800 text-white leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="mb-4">
                    <label for="edit-photo" class="block text-gray-300 text-sm font-bold mb-2">Photo URL:</label>
                    <input type="text" id="edit-photo" class="shadow appearance-none border rounded w-full py-2 px-3 bg-blue-800 text-white leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="mb-4">
                    <label for="edit-details" class="block text-gray-300 text-sm font-bold mb-2">Details:</label>
                    <textarea id="edit-details" rows="4" class="shadow appearance-none border rounded w-full py-2 px-3 bg-blue-800 text-white leading-tight focus:outline-none focus:shadow-outline"></textarea>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button id="save-student-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-6 rounded-full transition-colors duration-300">Save Changes</button>
                    <button id="cancel-edit-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-full transition-colors duration-300">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        window.onload = function() {
            // --- Firebase Initialization ---
            const firebaseConfig = {
                apiKey: "AIzaSyDDD1s6cSY16oPy40Wb6XfARf5BzHo0c6A",
                authDomain: "interactive-digital-yearbook.firebaseapp.com",
                projectId: "interactive-digital-yearbook",
                storageBucket: "interactive-digital-yearbook.firebasestorage.app",
                messagingSenderId: "814017258642",
                appId: "1:814017258642:web:aa40678665af257f1ef24b"
            };

            const config = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            const app = firebase.initializeApp(config);
            const db = app.firestore();
            const auth = app.auth();

            // Initial mock student data (used for reset)
            const initialStudentsData = [
                { 
                    name: "Maria Clara Dela Cruz", 
                    course: "BSIT", 
                    photo: "https://placehold.co/400x400/3182ce/ffffff?text=Maria+Clara",
                    details: "Maria Clara is an outstanding student known for her dedication to web development and passion for community service. She actively participates in various university organizations and aspires to be a software engineer."
                },
                { 
                    name: "Juan Luna", 
                    course: "BSCS", 
                    photo: "https://placehold.co/400x400/3182ce/ffffff?text=Juan+Luna",
                    details: "Juan Luna is a bright computer science student with a keen interest in artificial intelligence and machine learning. He's a member of the university's robotics club and often volunteers for tech workshops."
                },
                { 
                    name: "Jose Rizal", 
                    course: "BSECE", 
                    photo: "https://placehold.co/400x400/3182ce/ffffff?text=Jose+Rizal",
                    details: "Jose Rizal excels in electronics and communications engineering. He's a natural leader and has led several successful projects, demonstrating strong problem-solving skills and a commitment to innovation."
                },
                { 
                    name: "Gabriela Silang", 
                    course: "BSBA", 
                    photo: "https://placehold.co/400x400/3182ce/ffffff?text=Gabriela+Silang",
                    details: "Gabriela Silang is a highly motivated business administration student specializing in marketing. Her entrepreneurial spirit and excellent communication skills make her a valuable asset in group projects."
                },
                { 
                    name: "Andres Bonifacio", 
                    course: "BSIT", 
                    photo: "https://placehold.co/400x400/3182ce/ffffff?text=Andres+Bonifacio",
                    details: "Andres Bonifacio is a driven IT student with a focus on network security. He's an avid learner of cybersecurity best practices and is always eager to take on new challenges."
                },
                { 
                    name: "Emilio Aguinaldo", 
                    course: "BSCS", 
                    photo: "https://placehold.co/400x400/3182ce/ffffff?text=Emilio+Aguinaldo",
                    details: "Emilio Aguinaldo is a dedicated computer science major, passionate about data science and analytics. He enjoys participating in coding competitions and is known for his analytical thinking."
                },
                { 
                    name: "Benigno Aquino", 
                    course: "BSECE", 
                    photo: "https://placehold.co/400x400/3182ce/ffffff?text=Benigno+Aquino",
                    details: "Benigno Aquino is a focused ECE student with a strong aptitude for circuit design and signal processing. He's an active member of the engineering student council, advocating for his peers."
                },
                { 
                    name: "Cory Aquino", 
                    course: "BSBA", 
                    photo: "https://placehold.co/400x400/3182ce/ffffff?text=Cory+Aquino",
                    details: "Cory Aquino is an inspirational business student, passionate about social enterprises and leadership. She's a key organizer of university events and a mentor to junior students."
                },
                { 
                    name: "Apolinario Mabini", 
                    course: "BSIT", 
                    photo: "https://placehold.co/400x400/3182ce/ffffff?text=Apolinario+Mabini",
                    details: "Apolinario Mabini is a brilliant IT student, specializing in software engineering. His logical approach and meticulous attention to detail ensure high-quality code and innovative solutions."
                },
                { 
                    name: "Gregorio del Pilar", 
                    course: "BSCS", 
                    photo: "https://placehold.co/400x400/3182ce/ffffff?text=Gregorio+del+Pilar",
                    details: "Gregorio del Pilar is an enthusiastic computer science student, with a flair for game development and graphics. He's always exploring new technologies and pushing creative boundaries."
                },
            ];
            
            let students = []; // Students will now be populated from Firestore
            let isAdminMode = false;

            // DOM Elements for Search and Student Display
            const searchInput = document.getElementById('search-input');
            const studentResultsDiv = document.getElementById('student-results');
            const noResultsMessage = document.getElementById('no-results-message');

            // DOM Elements for Student Detail/Edit Modal
            const studentModal = document.getElementById('student-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const modalTitle = document.getElementById('modal-title');

            // View Mode Elements
            const viewModeDetails = document.getElementById('view-mode-details');
            const modalStudentName = document.getElementById('modal-student-name');
            const modalStudentPhoto = document.getElementById('modal-student-photo');
            const modalStudentCourse = document.getElementById('modal-student-course');
            const modalStudentDetails = document.getElementById('modal-student-details');

            // Edit Mode Elements
            const editModeForm = document.getElementById('edit-mode-form');
            const editStudentId = document.getElementById('edit-student-id');
            const editName = document.getElementById('edit-name');
            const editCourse = document.getElementById('edit-course');
            const editPhoto = document.getElementById('edit-photo');
            const editDetails = document.getElementById('edit-details');
            const saveStudentBtn = document.getElementById('save-student-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');

            // Admin UI Elements
            const adminLoginArea = document.getElementById('admin-login-area');
            const adminControlsArea = document.getElementById('admin-controls-area');
            const adminEmailInput = document.getElementById('admin-email-input');
            const adminPasswordInput = document.getElementById('admin-password-input');
            const adminLoginBtn = document.getElementById('admin-login-btn');
            const adminLogoutBtn = document.getElementById('admin-logout-btn');
            const addStudentBtn = document.getElementById('add-student-btn');
            const resetStudentsBtn = document.getElementById('reset-students-btn');
            const adminMessage = document.getElementById('admin-message');

            // Firestore collection path for students
            const studentsCollectionRef = db.collection(`artifacts/${appId}/public/data/students`);

            /**
             * Fetches all student data from Firestore.
             */
            async function fetchStudents() {
                try {
                    const snapshot = await studentsCollectionRef.orderBy("name").get();
                    students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log("Fetched students:", students); // Log fetched data
                    handleSearch(); // Re-render the UI with fetched students (including initial display)
                } catch (error) {
                    console.error("Error fetching students:", error);
                }
            }

            /**
             * Renders a list of student cards to the DOM.
             * Includes edit/delete buttons if in admin mode.
             * @param {Array} studentList - The array of student objects to display.
             */
            function renderStudents(studentList) {
                studentResultsDiv.innerHTML = '';
                noResultsMessage.classList.add('hidden');

                if (studentList.length === 0) {
                    noResultsMessage.classList.remove('hidden');
                    return;
                }

                studentList.forEach(student => {
                    const card = document.createElement('div');
                    card.classList.add('bg-blue-900', 'p-4', 'rounded-lg', 'shadow-lg', 'text-center', 'relative'); 
                    
                    if (isAdminMode) {
                        card.classList.add('admin-active');
                    }

                    let adminButtonsHtml = '';
                    if (isAdminMode) {
                        adminButtonsHtml = `
                            <div class="absolute top-2 right-2 flex space-x-2">
                                <button data-id="${student.id}" class="edit-student-card bg-sky-600 hover:bg-sky-700 p-2 rounded-full text-white text-xs leading-none">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 5.232z"></path></svg>
                                </button>
                                <button data-id="${student.id}" class="delete-student-card bg-red-600 hover:bg-red-700 p-2 rounded-full text-white text-xs leading-none">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1  0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                        `;
                    }

                    card.innerHTML = `
                        ${adminButtonsHtml}
                        <img src="${student.photo}" alt="${student.name}" class="rounded-full w-24 h-24 mx-auto mb-4 object-cover">
                        <h3 class="text-xl font-bold text-white">${student.name}</h3>
                        <p class="text-gray-400 mt-2 text-sm">${student.course}</p>
                    `;
                    
                    if (!isAdminMode) {
                        card.classList.add('cursor-pointer', 'hover:bg-blue-800', 'transition-colors', 'duration-300');
                        card.addEventListener('click', () => {
                            displayStudentDetails(student);
                        });
                    } else {
                        card.classList.add('cursor-default');
                    }

                    studentResultsDiv.appendChild(card);
                });

                if (isAdminMode) {
                    document.querySelectorAll('.edit-student-card').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const studentId = event.currentTarget.dataset.id; // Use string id for Firestore
                            const studentToEdit = students.find(s => s.id === studentId);
                            if (studentToEdit) {
                                openEditModal(studentToEdit);
                            }
                        });
                    });
                    document.querySelectorAll('.delete-student-card').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const studentId = event.currentTarget.dataset.id; // Use string id for Firestore
                            deleteStudent(studentId);
                        });
                    });
                }
            }

            /**
             * Displays the details of a specific student in the modal.
             * @param {Object} student - The student object to display.
             */
            function displayStudentDetails(student) {
                modalTitle.textContent = "Student Details";
                viewModeDetails.classList.remove('hidden');
                editModeForm.classList.add('hidden');

                modalStudentName.textContent = student.name;
                modalStudentPhoto.src = student.photo;
                modalStudentPhoto.alt = student.name;
                modalStudentCourse.textContent = student.course;
                modalStudentDetails.textContent = student.details;
                studentModal.classList.remove('hidden');
            }

            /**
             * Opens the modal in edit mode with pre-filled student data.
             * @param {Object} student - The student object to edit.
             */
            function openEditModal(student) {
                modalTitle.textContent = "Edit Student";
                viewModeDetails.classList.add('hidden');
                editModeForm.classList.remove('hidden');

                editStudentId.value = student.id;
                editName.value = student.name;
                editCourse.value = student.course;
                editPhoto.value = student.photo;
                editDetails.value = student.details;
                
                studentModal.classList.remove('hidden');
            }

            /**
             * Opens the modal for adding a new student.
             */
            function openAddStudentModal() {
                modalTitle.textContent = "Add New Student";
                viewModeDetails.classList.add('hidden');
                editModeForm.classList.remove('hidden');

                editStudentId.value = ''; // Ensure ID is empty for new student
                editName.value = '';
                editCourse.value = '';
                editPhoto.value = 'https://placehold.co/400x400/3182ce/ffffff?text=New+Student'; // Default photo
                editDetails.value = '';

                studentModal.classList.remove('hidden');
            }


            /**
             * Saves changes to an existing student or adds a new student to Firestore.
             */
            async function saveStudent() {
                const id = editStudentId.value; // Will be empty for new students
                const name = editName.value.trim();
                const course = editCourse.value.trim();
                const photo = editPhoto.value.trim();
                const details = editDetails.value.trim();

                if (!name || !course) {
                    alert('Name and Course are required!'); // Consider custom modal
                    return;
                }

                try {
                    if (id) {
                        // Update existing student in Firestore
                        await studentsCollectionRef.doc(id).update({ name, course, photo, details });
                    } else {
                        // Add new student to Firestore
                        await studentsCollectionRef.add({ name, course, photo, details });
                    }
                    studentModal.classList.add('hidden');
                    await fetchStudents(); // Re-fetch and re-render students after save
                } catch (error) {
                    console.error("Error saving student to Firestore:", error);
                    alert("Failed to save student data. Check console for details."); // Consider custom modal
                }
            }

            /**
             * Deletes a student from Firestore.
             * @param {string} id - The Firestore document ID of the student to delete.
             */
            async function deleteStudent(id) {
                if (confirm('Are you sure you want to delete this student? This action cannot be undone.')) { // Consider custom modal
                    try {
                        await studentsCollectionRef.doc(id).delete();
                        await fetchStudents(); // Re-fetch and re-render students after delete
                    } catch (error) {
                        console.error("Error deleting student from Firestore:", error);
                        alert("Failed to delete student. Check console for details."); // Consider custom modal
                    }
                }
            }
            
            /**
             * Filters the student list based on the search query and renders the results.
             * This operates on the 'students' array which is populated from Firestore.
             */
            function handleSearch() {
                const query = searchInput.value.toLowerCase().trim();
                console.log("Search query:", query);
                console.log("Current students array length:", students.length);
                const filteredStudents = students.filter(student => {
                    // Defensive check for undefined properties before calling toLowerCase()
                    const studentName = student.name ? student.name.toLowerCase() : '';
                    const studentCourse = student.course ? student.course.toLowerCase() : '';
                    return studentName.includes(query) || studentCourse.includes(query);
                });
                console.log("Filtered students length:", filteredStudents.length, filteredStudents);
                renderStudents(filteredStudents);
            }

            /**
             * Enables Admin Mode, showing controls and allowing edits.
             */
            function enableAdminMode() {
                isAdminMode = true;
                adminLoginArea.classList.add('hidden');
                adminControlsArea.classList.remove('hidden');
                adminMessage.textContent = `Logged in as ${auth.currentUser.email}. Manage student profiles below.`;
                renderStudents(students); // Re-render to show edit/delete buttons
            }

            /**
             * Disables Admin Mode, hiding controls.
             */
            function disableAdminMode() {
                isAdminMode = false;
                adminEmailInput.value = '';
                adminPasswordInput.value = '';
                adminLoginArea.classList.remove('hidden');
                adminControlsArea.classList.add('hidden');
                renderStudents(students); // Re-render to hide edit/delete buttons
            }

            // --- Event Listeners ---
            adminLoginBtn.addEventListener('click', async () => {
                const email = adminEmailInput.value.trim();
                const password = adminPasswordInput.value.trim();

                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (error) {
                    console.error("Admin login error:", error);
                    let errorMessage = 'Login failed.';
                    if (error.code === 'auth/operation-not-allowed') {
                        errorMessage += ' The Email/Password sign-in method is disabled for this Firebase project. Enable it in the Firebase console, under the "Sign-in method" tab of the "Authentication" section.';
                    } else {
                        errorMessage += ' ' + error.message;
                    }
                    alert(errorMessage);
                    adminPasswordInput.value = '';
                }
            });

            adminLogoutBtn.addEventListener('click', async () => {
                try {
                    await auth.signOut();
                } catch (error) {
                    console.error("Logout error:", error);
                    alert('Logout failed: ' + error.message);
                }
            });

            addStudentBtn.addEventListener('click', openAddStudentModal);
            saveStudentBtn.addEventListener('click', saveStudent);
            cancelEditBtn.addEventListener('click', () => studentModal.classList.add('hidden'));

            resetStudentsBtn.addEventListener('click', async () => {
                if (confirm('Are you sure you want to reset all student data to the initial state? This cannot be undone.')) {
                    try {
                        // 1. Delete all existing documents in the collection
                        const snapshot = await studentsCollectionRef.get();
                        const batch = db.batch();
                        snapshot.docs.forEach((doc) => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();

                        // 2. Add initial mock data
                        const addBatch = db.batch();
                        initialStudentsData.forEach(student => {
                            const docRef = studentsCollectionRef.doc();
                            addBatch.set(docRef, { 
                                name: student.name, 
                                course: student.course, 
                                photo: student.photo, 
                                details: student.details 
                            });
                        });
                        await addBatch.commit();

                        await fetchStudents();
                        alert('Student data has been reset!');
                    } catch (error) {
                        console.error("Error resetting data:", error);
                        alert("Failed to reset student data. Check console for details.");
                    }
                }
            });

            // Listen for Firebase Authentication state changes
            auth.onAuthStateChanged(async user => {
                if (user) {
                    if (user.email) {
                        enableAdminMode();
                    } else {
                        disableAdminMode();
                    }
                } else {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                         try {
                            await auth.signInWithCustomToken(__initial_auth_token);
                            console.log("Signed in with Canvas custom token.");
                        } catch (tokenError) {
                            console.error("Error signing in with custom token:", tokenError);
                            try {
                                await auth.signInAnonymously();
                                console.log("Signed in anonymously after custom token failure.");
                            } catch (anonError) {
                                console.error("Error signing in anonymously:", anonError);
                            }
                        }
                    } else {
                        try {
                            await auth.signInAnonymously();
                            console.log("Signed in anonymously.");
                        } catch (error) {
                            console.error("Error signing in anonymously:", error);
                        }
                    }
                    disableAdminMode();
                }
                fetchStudents();
            });
            
            searchInput.addEventListener('input', handleSearch);

            closeModalBtn.addEventListener('click', () => {
                studentModal.classList.add('hidden');
            });

            studentModal.addEventListener('click', (event) => {
                if (event.target === studentModal) {
                    studentModal.classList.add('hidden');
                }
            });
        };
    </script>

</body>
</html>
